var Y,Ae=()=>{Y=new Int32Array(256);let r=-306674912;for(let e=0;e<256;e++){let n=e;for(let t=8;t>0;--t)n=n&1?n>>>1^r:n>>>1;Y[e]=n}},v=(r,e)=>{e=e===void 0?4294967295:e^-1,Y===void 0&&Ae();for(let n=0;n<r.length;++n)e=Y[(e^r[n])&255]^e>>>8;return(e^-1)>>>0};var he=()=>new Uint8Array(Uint32Array.of(1).buffer)[0]===1,X=he();var C=(...r)=>{let e=[0];for(let t of r)e.push(e[e.length-1]+t.length);let n=new Uint8Array(e.pop());for(let t of r)n.set(t,e.shift());return n};function le(r,e,n,t){return r=r??0,t=t??0,n===void 0?[r+t,e===void 0?e:e+t,n]:(e=e??n,r+=r>=0?0:n,e+=e>=0?0:n,n=e-r,[r+t,e+t,n>=0?n:0])}var $=(r,e,n=0,t,o)=>{[t,o]=le(t,o,r.length);let i=[];for(let a=t;a<o;a+=e+n)i.push(r.slice(a,a+e));return i};var xe=new TextEncoder,ge=new TextDecoder;var k=r=>xe.encode(r),se=(r,e=0,n)=>{let t=n===void 0?void 0:e+n,o=r.subarray(e,t);return[ge.decode(o),o.length]};function de(r){let e=1,n=0,t=r.length;for(let o=0;o<t;o++)e=(e+r[o])%65521,n=(e+n)%65521;return(n<<16)+e}var M=Object.freeze({UNCOMPRESSED:0,FIXED:1,DYNAMIC:2}),V=131072,H=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],B=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],D=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],P=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function j(r){let e=Object.keys(r),n=0,t=0,o=Number.MAX_SAFE_INTEGER;e.forEach(m=>{n=Number(m),t<n&&(t=n),o>n&&(o=n)});let i=0,a,l={};for(let m=o;m<=t;m++){a=r[m],a===void 0&&(a=[]),a.sort((A,d)=>A<d?-1:A>d?1:0);let h={};a.forEach(A=>{h[i]=A,i++}),l[m]=h,i<<=1}return l}function fe(){let r={};r[7]=[],r[8]=[],r[9]=[];for(let e=0;e<=287;e++)e<=143?r[8].push(e):e<=255?r[9].push(e):e<=279?r[7].push(e):r[8].push(e);return r}function Z(r,e=15){let n={};for(let u of r)n[u]?n[u]++:n[u]=1;let t=Object.keys(n),o=[],i=0,a=[];if(t.length===1)a.push({count:n[0],simbles:[Number(t[0])]});else for(let u=0;u<e;u++){for(a=[],t.forEach(y=>{let w={count:n[Number(y)],simbles:[Number(y)]};a.push(w)}),i=0;i+2<=o.length;){let y={count:o[i].count+o[i+1].count,simbles:o[i].simbles.concat(o[i+1].simbles)};a.push(y),i+=2}a=a.sort((y,w)=>y.count<w.count?-1:y.count>w.count?1:0),a.length%2!==0&&a.pop(),o=a}let l={};a.forEach(u=>{u.simbles.forEach(y=>{l[y]?l[y]++:l[y]=1})});let m,h=Object.keys(l),A={},d=0,p=3,g=p,b=Number.MAX_SAFE_INTEGER,x=0;h.forEach(u=>{p=l[Number(u)],A[p]||(A[p]=[],b>p&&(b=p),x<p&&(x=p)),A[p].push(Number(u))}),d=0;let c=new Map;for(let u=b;u<=x;u++)m=A[u],m&&(m=m.sort((y,w)=>y<w?-1:y>w?1:0),m.forEach(y=>{c.set(y,{code:d,bitlen:u}),d++})),d<<=1;return c}var me=3,Te=128,_e=16,Ee=8;function we(r,e,n){let t=e+n-me,o={};for(let i=e;i<=t;i++){let a=r[i]<<16|r[i+1]<<8|r[i+2];o[a]===void 0&&(o[a]=[]),o[a].push(i)}return o}function be(r,e,n){let t=e,o=e+n-me,i=0,a=0,l=0,m=0,h=0,A=0,d=0,p=[],g={},b={},x=we(r,e,n);for(;t<=o;){let c=r[t]<<16|r[t+1]<<8|r[t+2],u=x[c];if(u===void 0||u.length<=1){p.push([r[t]]),t++;continue}i=t>32768?t-32768:0,l=0,m=0;let y=g[c]||0;for(;u[y]<i;)y=y+1|0;for(g[c]=y,y=b[c]||0;u[y]<t;)y=y+1|0;b[c]=y;let w=0;e:for(let f=b[c]-1,s=g[c];s<=f&&!(w>=Te||l>=Ee&&w>=_e);f--){w++;let _=u[f];for(let T=l-1;0<T;T--)if(r[_+T]!==r[t+T])continue e;a=258;for(let T=l;T<=258;T++)if(r[_+T]!==r[t+T]){a=T;break}if(l<a&&(l=a,m=_,258<=a))break}if(l>=3&&t+l<=o){h=t-m;for(let f=0;f<B.length&&!(B[f]>l);f++)A=f;for(let f=0;f<D.length&&!(D[f]>h);f++)d=f;p.push([A,d,l,h]),t+=l}else p.push([r[t]]),t++}return p.push([r[t]]),p.push([r[t+1]]),p}var U=class{buffer;bufferIndex;nowBits;nowBitsIndex=0;isEnd=!1;constructor(e,n=0,t=0){this.buffer=e,this.bufferIndex=n,this.nowBits=e[n],this.nowBitsIndex=t}write(e){if(this.isEnd)throw new Error("Lack of data length");e<<=this.nowBitsIndex,this.nowBits+=e,this.nowBitsIndex++,this.nowBitsIndex>=8&&(this.buffer[this.bufferIndex]=this.nowBits,this.bufferIndex++,this.nowBits=0,this.nowBitsIndex=0,this.buffer.length<=this.bufferIndex&&(this.isEnd=!0))}writeRange(e,n){let t=1,o=0;for(let i=0;i<n;i++)o=e&t?1:0,this.write(o),t<<=1}writeRangeCoded(e,n){let t=1<<n-1,o=0;for(let i=0;i<n;i++)o=e&t?1:0,this.write(o),t>>>=1}};function pe(r){let e=r.length,n=e<V/2?V:e*2,t=new U(new Uint8Array(n)),o=0,i=0;for(;o+V>=e?(i=e-o,t.writeRange(1,1)):(i=V,t.writeRange(0,1)),t.writeRange(M.DYNAMIC,2),Ne(t,r,o,i),o+=V,!(o>=e););return t.nowBitsIndex!==0&&t.writeRange(0,8-t.nowBitsIndex),t.buffer.subarray(0,t.bufferIndex)}function Ne(r,e,n,t){let o=be(e,n,t),i=[256],a=[],l=256,m=0;for(let s=0,_=o.length;s<_;s++){let T=o[s],R=T[0],N=T[1];N!==void 0&&(R+=257,a.push(N),m<N&&(m=N)),i.push(R),l<R&&(l=R)}let h=Z(i),A=Z(a),d=[];for(let s=0;s<=l;s++)h.has(s)?d.push(h.get(s).bitlen):d.push(0);let p=d.length;for(let s=0;s<=m;s++)A.has(s)?d.push(A.get(s).bitlen):d.push(0);let g=d.length-p,b=[],x=[],c=0,u=0;for(let s=0;s<d.length;s++){for(c=d[s],u=1;c===d[s+1];)if(u++,s++,c===0){if(138<=u)break}else if(6<=u)break;if(4<=u)c===0?11<=u?b.push(18):b.push(17):(b.push(c),x.push(1),u--,b.push(16)),x.push(u);else for(let _=0;_<u;_++)b.push(c),x.push(1)}let y=Z(b,7),w=0;G.forEach((s,_)=>{y.has(s)&&(w=_+1)}),r.writeRange(p-257,5),r.writeRange(g-1,5),r.writeRange(w-4,4);let f;for(let s=0;s<w;s++)f=y.get(G[s]),f!==void 0?r.writeRange(f.bitlen,3):r.writeRange(0,3);b.forEach((s,_)=>{if(f=y.get(s),f!==void 0)r.writeRangeCoded(f.code,f.bitlen);else throw new Error("Data is corrupted");s===18?r.writeRange(x[_]-11,7):s===17?r.writeRange(x[_]-3,3):s===16&&r.writeRange(x[_]-3,2)});for(let s=0,_=o.length;s<_;s++){let T=o[s],R=T[0],N=T[1];if(N!==void 0){if(f=h.get(R+257),f===void 0)throw new Error("Data is corrupted");r.writeRangeCoded(f.code,f.bitlen),0<H[R]&&(u=T[2],r.writeRange(u-B[R],H[R]));let L=A.get(N);if(L===void 0)throw new Error("Data is corrupted");if(r.writeRangeCoded(L.code,L.bitlen),0<P[N]){let F=T[3];r.writeRange(F-D[N],P[N])}}else{if(f=h.get(R),f===void 0)throw new Error("Data is corrupted");r.writeRangeCoded(f.code,f.bitlen)}}if(f=h.get(256),f===void 0)throw new Error("Data is corrupted");r.writeRangeCoded(f.code,f.bitlen)}var z=class{buffer;bufferIndex;nowBits;nowBitsLength=0;isEnd=!1;constructor(e,n=0){this.buffer=e,this.bufferIndex=n,this.nowBits=e[n],this.nowBitsLength=8}read(){if(this.isEnd)throw new Error("Lack of data length");let e=this.nowBits&1;return this.nowBitsLength>1?(this.nowBitsLength--,this.nowBits>>=1):(this.bufferIndex++,this.bufferIndex<this.buffer.length?(this.nowBits=this.buffer[this.bufferIndex],this.nowBitsLength=8):(this.nowBitsLength=0,this.isEnd=!0)),e}readRange(e){for(;this.nowBitsLength<=e;)this.nowBits|=this.buffer[++this.bufferIndex]<<this.nowBitsLength,this.nowBitsLength+=8;let n=this.nowBits&(1<<e)-1;return this.nowBits>>>=e,this.nowBitsLength-=e,n}readRangeCoded(e){let n=0;for(let t=0;t<e;t++)n<<=1,n|=this.read();return n}};var q=class{index=0;buffer;length;_extendedSize;constructor(e){this.buffer=new Uint8Array(e),this.length=e,this._extendedSize=e}write(e){if(this.length<=this.index){this.length+=this._extendedSize;let n=new Uint8Array(this.length),t=this.buffer.length;for(let o=0;o<t;o++)n[o]=this.buffer[o];this.buffer=n}this.buffer[this.index]=e,this.index++}};var Re=j(fe());function ye(r,e=0){let n=new q(r.length*10),t=new z(r,e),o=0,i=0;for(;o!==1;){if(o=t.readRange(1),i=t.readRange(2),i===M.UNCOMPRESSED)Ce(t,n);else if(i===M.FIXED)Be(t,n);else if(i===M.DYNAMIC)De(t,n);else throw new Error("Not supported BTYPE : "+i);if(o===0&&t.isEnd)throw new Error("Data length is insufficient")}return n.buffer.subarray(0,n.index)}function Ce(r,e){r.nowBitsLength<8&&r.readRange(r.nowBitsLength);let n=r.readRange(8)|r.readRange(8)<<8,t=r.readRange(8)|r.readRange(8)<<8;if(n+t!==65535)throw new Error("Data is corrupted");for(let o=0;o<n;o++)e.write(r.readRange(8))}function Be(r,e){let n=Re,t=Object.keys(n),o=0,i=0,a=Number.MAX_SAFE_INTEGER;t.forEach(c=>{o=Number(c),i<o&&(i=o),a>o&&(a=o)});let l=0,m,h,A,d,p,g,b,x;for(;!r.isEnd;){for(m=void 0,o=a,l=r.readRangeCoded(a);m=n[o][l],m===void 0;){if(i<=o)throw new Error("Data is corrupted");o++,l<<=1,l|=r.read()}if(m<256){e.write(m);continue}if(m===256)break;h=m-257,A=B[h],d=H[h],0<d&&(A+=r.readRange(d)),p=r.readRangeCoded(5),g=D[p],b=P[p],0<b&&(g+=r.readRange(b)),x=e.index-g;for(let c=0;c<A;c++)e.write(e.buffer[x+c])}}function De(r,e){let n=r.readRange(5)+257,t=r.readRange(5)+1,o=r.readRange(4)+4,i=0,a={};for(let E=0;E<o;E++)i=r.readRange(3),i!==0&&(a[i]||(a[i]=[]),a[i].push(G[E]));let l=j(a),m=Object.keys(l),h=0,A=Number.MAX_SAFE_INTEGER;m.forEach(E=>{i=Number(E),h<i&&(h=i),A>i&&(A=i)});let d={},p={},g=0,b,x=0,c=0,u=n+t;for(let E=0;E<u;){for(b=void 0,i=A,g=r.readRangeCoded(A);b=l[i][g],b===void 0;){if(h<=i)throw new Error("Data is corrupted");i++,g<<=1,g|=r.read()}if(b===16?x=3+r.readRange(2):b===17?(x=3+r.readRange(3),c=0):b===18?(x=11+r.readRange(7),c=0):(x=1,c=b),c<=0)E+=x;else for(;x;)E<n?(d[c]||(d[c]=[]),d[c].push(E++)):(p[c]||(p[c]=[]),p[c].push(E++-n)),x--}let y=j(d),w=j(p),f=Object.keys(y),s=0,_=0,T=Number.MAX_SAFE_INTEGER;f.forEach(E=>{s=Number(E),_<s&&(_=s),T>s&&(T=s)});let R=Object.keys(w),N=0,L=0,F=Number.MAX_SAFE_INTEGER;R.forEach(E=>{N=Number(E),L<N&&(L=N),F>N&&(F=N)});let J=0,S,ne,te,oe,O,ie,ae,W,K,ce;for(;!r.isEnd;){for(S=void 0,s=T,J=r.readRangeCoded(T);S=y[s][J],S===void 0;){if(_<=s)throw new Error("Data is corrupted");s++,J<<=1,J|=r.read()}if(S<256){e.write(S);continue}if(S===256)break;for(ne=S-257,te=B[ne],oe=H[ne],0<oe&&(te+=r.readRange(oe)),O=void 0,W=F,K=r.readRangeCoded(F);O=w[W][K],O===void 0;){if(L<=W)throw new Error("Data is corrupted");W++,K<<=1,K|=r.read()}ie=D[O],ae=P[O],0<ae&&(ie+=r.readRange(ae)),ce=e.index-ie;for(let E=0;E<te;E++)e.write(e.buffer[ce+E])}}function Q(r){let e=new z(r);if(e.readRange(4)!==8)throw new Error("Not compressed by deflate");let t=e.readRange(4),o=e.readRange(5),i=e.readRange(1),a=e.readRange(2);return ye(r,2)}function ee(r){let e=pe(r),n=new U(new Uint8Array(1));n.writeRange(8,4),n.writeRange(7,4);let t=new U(new Uint8Array(1));t.writeRange(28,5),t.writeRange(0,1),t.writeRange(2,2);let o=new U(new Uint8Array(4)),i=de(r);o.writeRange(i>>>24,8),o.writeRange(i>>>16&255,8),o.writeRange(i>>>8&255,8),o.writeRange(i&255,8);let a=new Uint8Array(e.length+6);return a.set(n.buffer),a.set(t.buffer,1),a.set(e,2),a.set(o.buffer,a.length-4),a}var Ue={1:0,2:2,4:14,8:254},I=r=>{let e=new Uint8Array(Uint32Array.of(r).buffer);return X?e.reverse():e},re=(r,e)=>{let n=r.slice(e,e+4);return X&&n.reverse(),new Uint32Array(n.buffer)[0]},Yr=(r,e,n,t,o=1)=>{console.assert(r.length*8/(t<8?8:t)==e*n),console.assert(e===(e|0)),console.assert(n===(n|0));let i=t<8?Ie(r,e,n,t):Se(r,e,n,t,o);return ee(i)},$r=(r,e,n,t,o=1)=>{let i=Q(r instanceof Uint8Array?r:Uint8Array.from(r));return console.assert(i.length==(Math.ceil(e*t/8)+1)*n),console.assert(e===(e|0)),console.assert(n===(n|0)),t<8?Le(i,e,n,t):Fe(i,e,n,t,o)},Ie=(r,e,n,t,o)=>{o=o??Ue[t];let i=8/t,a=Math.ceil(e*1/i),l=a*i-e,m=Array(l).fill(0),h=$(Array.from(r),e),A=Array(n).fill(void 0).map(d=>Array(a).fill(0));for(let d=0;d<n;d++){let p=h[d],g=A[d],b=g.length;p.push(...m);let x=0;for(let c=0;c<b;c++)for(let u=0;u<i;u++)x=p[c*i+u],g[c]+=x>o?o+1:x,g[c]<<=u<i-1?t:0;g.unshift(0)}return Uint8Array.from([].concat(...A))},Le=(r,e,n,t=1)=>{let o=8/t,i=Math.ceil(e*1/o),a=i*o-e,l=Array(n).fill(void 0).map(h=>Array(e+a).fill(0)),m=$(Array.from(r),i+1);for(let h=0;h<n;h++){let A=l[h],d=m[h],p=d.length;for(let g=1;g<p;g++)for(let b=0;b<o;b++){let x=8-(b+1)*t;A[(g-1)*o+b]=(d[g]&(1<<t)-1<<x)>>x}A.splice(e),console.assert(A.length===e)}return Uint8Array.from([].concat(...l))},Se=(r,e,n,t,o)=>Uint8Array.of(),Fe=(r,e,n,t,o)=>Uint8Array.of(),Zr=(r,e,n,t)=>C(ve(),ke(e,n,t),Me(r),Ve()),ve=()=>Uint8Array.of(137,80,78,71,13,10,26,10),ke=(r,e,n)=>{let t=I(13),o=C(k("IHDR"),I(r),I(e),[n,0,0,0,0]),i=I(v(o));return C(t,o,i)},Me=r=>{let e=I(r.length),n=k("IDAT"),t=I(v(r,v(n)));return C(e,n,r,t)},Ve=()=>C(I(0),k("IEND"),I(v(k("IEND")))),qr=(r,e=!0)=>{let n=8;n=ue(r,n,"IHDR");let t=re(r,n+4+4+0),o=re(r,n+4+4+4),i=r[n+4+4+4+1];n=ue(r,n,"IDAT");let a=re(r,n),l=r.slice(n+4+4,n+4+4+a);return e&&i<1&&(i=1),{width:t,height:o,bitdepth:i,zdata:l}},ue=(r,e,n)=>{let t=re(r,e),o=e+4+4+t+4;return n===void 0?o:se(r,e+4,4)[0]===n?e:ue(r,o,n)};export{$r as decodeBitmap,ee as deflate,Yr as encodeBitmap,Ie as filterBitmapSubByte,Q as inflate,Zr as makePng,qr as stripPngData,Le as unfilterBitmapSubByte};
/**
 * @license Copyright (c) 2018 zprodev
 */
